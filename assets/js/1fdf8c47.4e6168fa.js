"use strict";(self.webpackChunkokai_docs=self.webpackChunkokai_docs||[]).push([[69664],{95819:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"packages/database-adapters","title":"\ud83d\udd27 Database Adapters","description":"Overview","source":"@site/docs/packages/database-adapters.md","sourceDirName":"packages","slug":"/packages/database-adapters","permalink":"/okai/docs/packages/database-adapters","draft":false,"unlisted":false,"editUrl":"https://github.com/okcashpro/okai/tree/main/docs/docs/packages/database-adapters.md","tags":[],"version":"current","frontMatter":{}}');var s=r(74848),t=r(28453);const i={},o="\ud83d\udd27 Database Adapters",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Available Adapters",id:"available-adapters",level:2},{value:"Installation",id:"installation",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"SQLite (Development)",id:"sqlite-development",level:3},{value:"PostgreSQL (Production)",id:"postgresql-production",level:3},{value:"Supabase (Cloud)",id:"supabase-cloud",level:3},{value:"Core Concepts",id:"core-concepts",level:2},{value:"Memory Storage",id:"memory-storage",level:3},{value:"Relationships",id:"relationships",level:3},{value:"Goals",id:"goals",level:3},{value:"Common Operations",id:"common-operations",level:2},{value:"Memory Management",id:"memory-management",level:3},{value:"Relationship Management",id:"relationship-management",level:3},{value:"Goal Management",id:"goal-management",level:3},{value:"Vector Search",id:"vector-search",level:2},{value:"Performance Optimization",id:"performance-optimization",level:2},{value:"Connection Pooling (PostgreSQL)",id:"connection-pooling-postgresql",level:3},{value:"Memory Usage (SQLite)",id:"memory-usage-sqlite",level:3},{value:"Caching (All Adapters)",id:"caching-all-adapters",level:3},{value:"Schema Management",id:"schema-management",level:2},{value:"PostgreSQL Migrations",id:"postgresql-migrations",level:3},{value:"SQLite Schema",id:"sqlite-schema",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Extending Adapters",id:"extending-adapters",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Related Resources",id:"related-resources",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"-database-adapters",children:"\ud83d\udd27 Database Adapters"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Database Adapters provide the persistence layer for OKai, enabling storage and retrieval of memories, relationships, goals, and other core data. The system supports multiple database backends through a unified interface."}),"\n",(0,s.jsx)(n.h2,{id:"available-adapters",children:"Available Adapters"}),"\n",(0,s.jsx)(n.p,{children:"OKai includes the following database adapters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"PostgreSQL Adapter"})," (",(0,s.jsx)(n.code,{children:"@okai/adapter-postgres"}),") - Production-ready adapter for PostgreSQL databases"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"SQLite Adapter"})," (",(0,s.jsx)(n.code,{children:"@okai/adapter-sqlite"}),") - Lightweight adapter for SQLite, perfect for development"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"SQL.js Adapter"})," (",(0,s.jsx)(n.code,{children:"@okai/adapter-sqljs"}),") - In-memory SQLite adapter for testing"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Supabase Adapter"})," (",(0,s.jsx)(n.code,{children:"@okai/adapter-supabase"}),") - Cloud-native adapter for Supabase"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# PostgreSQL\r\npnpm add @okai/adapter-postgres\r\n\r\n# SQLite\r\npnpm add @okai/adapter-sqlite\r\n\r\n# SQL.js\r\npnpm add @okai/adapter-sqljs\r\n\r\n# Supabase\r\npnpm add @okai/adapter-supabase\n"})}),"\n",(0,s.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,s.jsx)(n.h3,{id:"sqlite-development",children:"SQLite (Development)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { SqliteDatabaseAdapter } from "@okai/adapter-sqlite";\r\nimport Database from "better-sqlite3";\r\n\r\nconst db = new SqliteDatabaseAdapter(new Database("./dev.db"));\n'})}),"\n",(0,s.jsx)(n.h3,{id:"postgresql-production",children:"PostgreSQL (Production)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { PostgresDatabaseAdapter } from "@okai/adapter-postgres";\r\n\r\nconst db = new PostgresDatabaseAdapter({\r\n  connectionString: process.env.DATABASE_URL,\r\n  // Optional connection pool settings\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n});\n'})}),"\n",(0,s.jsx)(n.h3,{id:"supabase-cloud",children:"Supabase (Cloud)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { SupabaseDatabaseAdapter } from "@okai/adapter-supabase";\r\n\r\nconst db = new SupabaseDatabaseAdapter(\r\n  process.env.SUPABASE_URL,\r\n  process.env.SUPABASE_SERVICE_API_KEY,\r\n);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,s.jsx)(n.h3,{id:"memory-storage",children:"Memory Storage"}),"\n",(0,s.jsx)(n.p,{children:"Memories are the fundamental unit of storage in OKai. They represent messages, documents, and other content with optional embeddings for semantic search."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface Memory {\r\n  id: UUID;\r\n  content: {\r\n    text: string;\r\n    attachments?: Attachment[];\r\n  };\r\n  embedding?: number[];\r\n  userId: UUID;\r\n  roomId: UUID;\r\n  agentId: UUID;\r\n  createdAt: number;\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"relationships",children:"Relationships"}),"\n",(0,s.jsx)(n.p,{children:"Relationships track connections between users and agents:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'interface Relationship {\r\n  userA: UUID;\r\n  userB: UUID;\r\n  status: "FRIENDS" | "BLOCKED";\r\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"goals",children:"Goals"}),"\n",(0,s.jsx)(n.p,{children:"Goals track objectives and their progress:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface Goal {\r\n  id: UUID;\r\n  roomId: UUID;\r\n  userId: UUID;\r\n  name: string;\r\n  status: GoalStatus;\r\n  objectives: Objective[];\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"common-operations",children:"Common Operations"}),"\n",(0,s.jsx)(n.h3,{id:"memory-management",children:"Memory Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Create a memory\r\nawait db.createMemory(\r\n  {\r\n    id: uuid(),\r\n    content: { text: "Hello world" },\r\n    userId: user.id,\r\n    roomId: room.id,\r\n    agentId: agent.id,\r\n    createdAt: Date.now(),\r\n  },\r\n  "messages",\r\n);\r\n\r\n// Search memories by embedding\r\nconst similar = await db.searchMemoriesByEmbedding(embedding, {\r\n  match_threshold: 0.8,\r\n  count: 10,\r\n  roomId: room.id,\r\n});\r\n\r\n// Get recent memories\r\nconst recent = await db.getMemories({\r\n  roomId: room.id,\r\n  count: 10,\r\n  unique: true,\r\n});\n'})}),"\n",(0,s.jsx)(n.h3,{id:"relationship-management",children:"Relationship Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Create relationship\r\nawait db.createRelationship({\r\n  userA: user1.id,\r\n  userB: user2.id,\r\n});\r\n\r\n// Get relationships for user\r\nconst relationships = await db.getRelationships({\r\n  userId: user.id,\r\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"goal-management",children:"Goal Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Create goal\r\nawait db.createGoal({\r\n  id: uuid(),\r\n  roomId: room.id,\r\n  userId: user.id,\r\n  name: "Complete task",\r\n  status: "IN_PROGRESS",\r\n  objectives: [],\r\n});\r\n\r\n// Get active goals\r\nconst goals = await db.getGoals({\r\n  roomId: room.id,\r\n  onlyInProgress: true,\r\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"vector-search",children:"Vector Search"}),"\n",(0,s.jsx)(n.p,{children:"All adapters support vector similarity search for memory retrieval:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Search by embedding vector\r\nconst memories = await db.searchMemories({\r\n  tableName: "memories",\r\n  roomId: room.id,\r\n  embedding: [0.1, 0.2, ...], // 1536-dimensional vector\r\n  match_threshold: 0.8,\r\n  match_count: 10,\r\n  unique: true\r\n});\r\n\r\n// Get cached embeddings\r\nconst cached = await db.getCachedEmbeddings({\r\n  query_table_name: "memories",\r\n  query_threshold: 0.8,\r\n  query_input: "search text",\r\n  query_field_name: "content",\r\n  query_field_sub_name: "text",\r\n  query_match_count: 10\r\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,s.jsx)(n.h3,{id:"connection-pooling-postgresql",children:"Connection Pooling (PostgreSQL)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const db = new PostgresDatabaseAdapter({\r\n  connectionString: process.env.DATABASE_URL,\r\n  max: 20, // Maximum pool size\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"memory-usage-sqlite",children:"Memory Usage (SQLite)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const db = new SqliteDatabaseAdapter(\r\n  new Database("./dev.db", {\r\n    memory: true, // In-memory database\r\n    readonly: false,\r\n    fileMustExist: false,\r\n  }),\r\n);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"caching-all-adapters",children:"Caching (All Adapters)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Enable memory caching\r\nconst memory = new MemoryManager({\r\n  runtime,\r\n  tableName: "messages",\r\n  cacheSize: 1000,\r\n  cacheTTL: 3600,\r\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"schema-management",children:"Schema Management"}),"\n",(0,s.jsx)(n.h3,{id:"postgresql-migrations",children:"PostgreSQL Migrations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:'-- migrations/20240318103238_remote_schema.sql\r\nCREATE TABLE memories (\r\n  id UUID PRIMARY KEY,\r\n  type TEXT NOT NULL,\r\n  content JSONB NOT NULL,\r\n  embedding vector(1536),\r\n  "userId" UUID NOT NULL,\r\n  "roomId" UUID NOT NULL,\r\n  "agentId" UUID NOT NULL,\r\n  "unique" BOOLEAN DEFAULT FALSE,\r\n  "createdAt" TIMESTAMP NOT NULL\r\n);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"sqlite-schema",children:"SQLite Schema"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const sqliteTables = `\r\nCREATE TABLE IF NOT EXISTS memories (\r\n  id TEXT PRIMARY KEY,\r\n  type TEXT NOT NULL,\r\n  content TEXT NOT NULL,\r\n  embedding BLOB,\r\n  userId TEXT NOT NULL,\r\n  roomId TEXT NOT NULL,\r\n  agentId TEXT NOT NULL,\r\n  "unique" INTEGER DEFAULT 0,\r\n  createdAt INTEGER NOT NULL\r\n);\r\n`;\n'})}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'try {\r\n  await db.createMemory(memory);\r\n} catch (error) {\r\n  if (error.code === "SQLITE_CONSTRAINT") {\r\n    // Handle unique constraint violation\r\n  } else if (error.code === "23505") {\r\n    // Handle Postgres unique violation\r\n  } else {\r\n    // Handle other errors\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"extending-adapters",children:"Extending Adapters"}),"\n",(0,s.jsxs)(n.p,{children:["To create a custom adapter, implement the ",(0,s.jsx)(n.code,{children:"DatabaseAdapter"})," interface:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"class CustomDatabaseAdapter extends DatabaseAdapter {\r\n  async createMemory(memory: Memory, tableName: string): Promise<void> {\r\n    // Custom implementation\r\n  }\r\n\r\n  async getMemories(params: {\r\n    roomId: UUID;\r\n    count?: number;\r\n    unique?: boolean;\r\n  }): Promise<Memory[]> {\r\n    // Custom implementation\r\n  }\r\n\r\n  // Implement other required methods...\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Connection Management"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use connection pooling for PostgreSQL"}),"\n",(0,s.jsx)(n.li,{children:"Close connections properly when using SQLite"}),"\n",(0,s.jsx)(n.li,{children:"Handle connection errors gracefully"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Vector Search"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Set appropriate match thresholds based on your use case"}),"\n",(0,s.jsx)(n.li,{children:"Index embedding columns for better performance"}),"\n",(0,s.jsx)(n.li,{children:"Cache frequently accessed embeddings"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Memory Management"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Implement cleanup strategies for old memories"}),"\n",(0,s.jsx)(n.li,{children:"Use unique flags to prevent duplicates"}),"\n",(0,s.jsx)(n.li,{children:"Consider partitioning large tables"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Error Handling"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Implement retries for transient failures"}),"\n",(0,s.jsx)(n.li,{children:"Log database errors with context"}),"\n",(0,s.jsx)(n.li,{children:"Use transactions for atomic operations"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Connection Timeouts"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Increase connection timeout\r\nconst db = new PostgresDatabaseAdapter({\r\n  connectionTimeoutMillis: 5000,\r\n});\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Memory Leaks"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Clean up old memories periodically\r\nawait db.removeAllMemories(roomId, tableName);\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Vector Search Performance"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Create appropriate indexes\r\nCREATE INDEX embedding_idx ON memories\r\nUSING ivfflat (embedding vector_cosine_ops)\r\nWITH (lists = 100);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"related-resources",children:"Related Resources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"../packages/core",children:"Memory Manager Documentation"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"../packages/database-adapters",children:"Vector Search Guide"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/api",children:"Database Schema Reference"})}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var a=r(96540);const s={},t=a.createContext(s);function i(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);